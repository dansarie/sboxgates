language: c
dist: focal
compiler:
  - gcc

addons:
  apt:
    update: true
    packages:
      - graphviz
      - libmpich-dev
      - libxml2-dev
      - mpich
      - nvidia-cuda-toolkit

before_install:
  - pip install --user cpp-coveralls

before_script:
  - mkdir build
  - cd build

script:
  - cmake -DENABLE_COVERAGE=ON ..
  - make
  - ./sboxgates -h
  - mpirun -N 4 ./sboxgates -b ../sboxes/des_s1.txt -vv -i 3 -o 0 -s -n
  - mpirun -N 4 ./sboxgates -b ../sboxes/des_s1.txt -vv -i 3 -s -n -g 1*.xml
  - rm *.xml
  - mpirun -N 4 ./sboxgates -b ../sboxes/des_s1.txt -vv -a 10694 -i 3 -p 63
  - ./sboxgates -d 4*.xml | dot -Tpng > /dev/null
  - ./sboxgates -c 4*.xml > test.c
  - $CC -c -Wall -Wpedantic -Werror test.c
  - rm *.xml *.c
  - mpirun -N 10 ./sboxgates -b ../sboxes/des_s1.txt -vv -a 10694 -l -o 0
  - ./sboxgates -d 1*.xml | dot -Tpng > /dev/null
  - ./sboxgates -c 1*.xml > test.cu
  - nvcc -c test.cu

after_success:
  - cd ..
  - coveralls --gcov-options '\-lp' -E '.*CMake.*'
